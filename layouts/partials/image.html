{{- /* set variables */ -}}
{{- $img := "" }}

{{- if eq .Type "global" -}}
  {{- /* global resource */ -}}
  {{- $img = resources.Get .src -}}
{{- else -}}
  {{- /* page resource */ -}}
  {{- $img = .page.Resources.GetMatch .src -}}
{{- end -}}
{{- if not $img }}
  {{- warnf "No image resource found at %s%s" .page.RelPermalink .src -}}
{{- end -}}
{{- $srcsets := slice -}}
{{- $widths := slice -}}
{{- $fillRatio := 0 -}}
{{- /* calculate fill ratio, if .fillRatio is provided */ -}}
{{- if .fillRatio -}}
  {{- /* height to width ratio of .fillRatio */ -}}
  {{- /* numbers must be converted to float before division or they will create an answer of 0 */ -}}
  {{- $fillRatio = div (index .fillRatio 1 | float) (index .fillRatio 0 | float) -}}
{{- end -}}
{{- /*********************************************************************
  **** if .width present for pixel density srcset                        *
  **** produce array [{desc: "1x", width: 300},{desc: "2x", width: 600}] *
  ************************************************************************/ -}}
{{- if .width -}}
  {{- $densities := .densities | default (.page.Param "image.densities") -}}
  {{- $densities = sort $densities -}}
  {{- range $density := $densities }}
    {{- $widths = $widths | append (slice
      (dict
      "desc" (printf "%dx" $density)
      "width" (mul $.width $density)
      )) -}}
  {{- end -}}
{{- else -}}
{{/* else produce responsive srcset
  * produce array [{desc: "300w", width: 300},{desc: "600w", width: 600}]
*/}}
  {{- $userWidths := .widths | default (.page.Param "image.widths") -}}
  {{- $userWidths = sort $userWidths -}}
  {{- range $userWidth := $userWidths }}
    {{- $widths = $widths | append (slice
      (dict
      "desc" (printf "%dw" $userWidth)
      "width" $userWidth
      )) -}}
  {{- end -}}
{{- end -}}
{{- /* set image processing options */ -}}
{{- $options := slice -}}
{{- with .quality -}}
  {{- if and (eq (printf "%T" .) "int") (and (ge . 1) (le . 100)) -}}
    {{ $options = $options | append (printf "q%d" .) -}}
  {{- else -}}
    {{- warnf "Invalid .quality of %v (%s). .quality must be integer of 1-100 inclusive." . $img.RelPermalink -}}
  {{- end -}}
{{- end -}}
{{- with .rotate -}}
  {{- if and (eq (printf "%T" .) "int") (and (ge . 1) (le . 360)) -}}
    {{ $options = $options | append (printf "r%d" .) -}}
  {{- else -}}
    {{- warnf "Invalid .rotate of %v (%s). .rotate must be integer of 1-360 inclusive." . $img.RelPermalink -}}
  {{- end -}}
{{- end -}}
{{- with .resampleFilter -}}
  {{- $filterOpts := (slice "Box" "NearestNeighbor" "Linear" "Gaussian") -}}
  {{- if in $filterOpts . -}}
    {{ $options = $options | append . -}}
  {{- else -}}
    {{- warnf "Invalid .resampleFilter of %v (%s). Valid .resampleFilter options are %s" . $img.RelPermalink (delimit $filterOpts ", ") -}}
  {{- end -}}
{{- end -}}
{{- with .hint -}}
  {{- $hintOpts := (slice "picture" "photo" "drawing" "icon" "text") -}}
  {{- if in $hintOpts . -}}
    {{ $options = $options | append . -}}
  {{- else -}}
    {{- warnf "Invalid .hint of %v (%s). Valid .hint options are %s" . $img.RelPermalink (delimit $hintOpts ", ") -}}
  {{- end -}}
{{- end -}}
{{- with .anchor -}}
  {{- $anchorOpts := (slice "Smart" "Center" "TopLeft" "Top" "TopRight" "Left" "Right" "BottomLeft" "Bottom" "BottomRight") -}}
  {{- if in $anchorOpts . -}}
    {{ $options = $options | append  . -}}
  {{- else -}}
    {{- warnf "Invalid .anchor of %v (%s). Valid .anchor options are %s" . $img.RelPermalink (delimit $anchorOpts ", ") -}}
  {{- end -}}
{{- end -}}
{{- /* ***********************
  **** picture tag variables *
  ****************************/ -}}
{{- $title := .page.Title -}}
{{- if .title -}}
  {{- $title = .title -}}
{{- else if .figureTitle -}}
  {{- $title = .figureTitle -}}
{{- end -}}
{{- $sizes := "" -}}
{{ if .sizes }}
  {{ $sizes = .sizes }}
{{- else if .page.Param "image.lazysizes" -}}
  {{- $sizes = "auto" }}
{{- else -}}
  {{ $sizes = "100vw" }}
{{- end -}}
{{- $class := .class | default (.page.Param "image.class") -}}
{{- if .page.Param "image.lazysizes" -}}
  {{- $class = print $class " " "lazyload" -}}
{{- end -}}
{{- if .figure }}
  {{- $class = print $class " " (.page.Param "image.figureImageClass") -}}
{{- end -}}
{{- /************************
  **** generate picture tag *
  ***************************/ -}}
{{- $partialVars := (dict
  "partial" .
  "widths" $widths
  "img" $img
  "options" $options
  ) -}}
{{- with partial "image-includes/generate-widths" $partialVars -}}
<picture>
  {{- range . }}
  <source
    {{ if or (eq .loading "auto") (eq (.page.Param "image.lazysizes") false) }}
      srcset="{{ .srcset }}"
    {{ else }}
      data-srcset="{{ .srcset }}"
    {{ end }}
    type="{{ .src.MediaType }}"
  />
  {{- end }}
  {{ with index . "original" }}
  {{ with .src }}
  <img
    {{ if eq $.loading "auto" }}
      loading="auto"
    {{ end }}
    {{ if or (eq $.loading "auto") (eq ($.page.Param "image.lazysizes") false) }}
      src="{{ .RelPermalink }}"
    {{ else }}
      data-src="{{ .RelPermalink }}"
    {{ end }}
    alt="{{ $.alt | default ( ($.caption | markdownify | plainify) | default (printf "Image of %s" $title)) }}"
    title="{{ $title }}"
    height="{{ .Height }}"
    width="{{ .Width }}"
    class="{{ $class }}"
    {{ if not $.width }}
      sizes="{{ $sizes }}"
    {{ end }}
  />
  {{- end -}}
  {{ end -}}
</picture>
{{ end }}
