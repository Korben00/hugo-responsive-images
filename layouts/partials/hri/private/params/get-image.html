{{/*
  get-image.html
  Takes inputs and page context.
  - converts image path into image resource

  @author @sean-au

  @context . Context from image partial

  @return Image and other params (via scratch) are merged with . input

  @access private

  @example - Go Template
  {{ partial "hri/private/params/get-image" . }}
  
*/}}

{{ $module := "Hugo Responsive Images" }}
{{ $message := false }}
{{ $s := newScratch }}
{{ $s.Set "params" dict }}

{{/* .page deprecated to be removed */}}
{{/* when .page is removed all instances of $ctx can be reverted to .ctx */}}
{{ $ctx := .ctx }}
{{ if .page }}
  {{  $ctx = .page }}
{{ end }}
{{ if not (or .ctx .page) }}
  {{ $message = printf "ctx must be set for image %s" .src }}
{{ end }}
{{ $s.SetInMap "params" "ctx" $ctx}}

{{/* check .ctx actually pointing to a page context */}}
{{ if and (ne  .input "render_hook") (ne .input "shortcode") }}
  {{ if ne (printf "%T" $ctx) "*hugolib.pageState" }}
    {{ $message = printf "ctx must be set for image %s via partial" .src }}
  {{ end }}
{{/* the following errors are code errors, not user errors as CTX is automatic */}}
{{ else if (eq .input "shortcode") }}
  {{ if ne (printf "%T" $ctx) "*hugolib.pageForShortcode" }}
    {{ $message = printf "Shortcode ctx error for image %s" .src }}
  {{ end }}
{{ else if (eq .input "render_hook") }}
  {{ warnf "rh source: %s" .src }}
  {{ if ne (printf "%T" $ctx) "*hugolib.pageForRenderHooks" }}
    {{ $message = printf "Render hook ctx error for image %s" .src }}
  {{ end }}
{{ end }}



{{/* .type deprecated, keep for v1. only use $type from v2 */}}
{{ $type := .type | default ( .ctx.Param "image.type") }}
{{ $src := false }}
{{ $prefix := substr .src 0 7 }}
{{ if eq $prefix "assets/" }}
  {{ $src = substr .src 7 }}
  {{ $type = "global" }}
{{ end }}
{{ if eq $type "global" }}
  {{ with resources.Get $src }}
    {{ $s.SetInMap "params" "img" .}}
  {{ else }}
    {{ $message = printf "Global resource image /assets/%s not found" $src}}
  {{ end }}
{{ else }}
  {{/* page resource */}}
  {{ with $ctx.Resources.GetMatch (print .src) }}
    {{ $s.SetInMap "params" "meta" .Params.image }}
    {{ $s.SetInMap "params" "img" . }}
  {{ else }}
    {{ $message = printf "Page resource image %s%s not found"  $.ctx.RelPermalink $.src }}
  {{ end }}
{{ end }}




{{ if $message }}
  {{ partial "img-common/private/utils/errorf" (dict "message" $message "module" $module) }}
{{ end }}

{{/* merge params scratch into original params */}}
{{ return merge . ($s.Get "params") }}
